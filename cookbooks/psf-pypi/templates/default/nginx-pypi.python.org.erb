# Generated by Chef
# Local modifications will be overwritten

<% if @domains.length > 1 %>
server {
  listen 80;
  server_name <%= @domains.drop(1).join(" ") %>;
  return 301 $scheme://<%= @domains.first %>$request_uri;
}
<% end %>

server {
  listen 80;
  server_name <%= @domains.first %>;

  client_max_body_size <%= @max_body_size %>;

  <% if @hsts_seconds %>
  add_header Strict-Transport-Security "max-age=<%= @hsts_seconds %>";
  <% end %>

  # TODO: Cache Static Assests

  location /static/ {
    alias <%= @static_root %>/;
  }

  location <%= @package_internal_url %> {
    alias     <%= @package_root %>;
    autoindex on;

    add_header X-PYPI-LAST-SERIAL $upstream_http_x_pypi_last_serial;

    <% if @hsts_seconds %>
    add_header Strict-Transport-Security "max-age=<%= @hsts_seconds %>";
    <% end %>

    internal;
  }

  location ~* ^/(pypi|daytime|mirrors|id|oauth|security|simple|serversig|packages).* {
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_redirect   off;

    proxy_pass       http://localhost:8000;
  }
}
