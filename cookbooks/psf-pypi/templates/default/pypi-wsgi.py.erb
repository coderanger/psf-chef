#!/usr/bin/env python
import sys;
sys.path = ["<%= @src_dir %>"] + sys.path


class ReverseProxied(object):
    """
    Corrects the SCRIPT_NAME and PATH_INFO so that PyPI can be mounted
    at multiple sub directories as it expects.
    """

    def __init__(self, app):
        self.app = app

    def __call__(self, environ, start_response):
        base, part1, part2 = environ["PATH_INFO"][1:].partition("/")

        environ["SCRIPT_NAME"] = "/" + base
        environ["PATH_INFO"] = part1 + part2

        return self.app(environ, start_response)

# Load the Real WSGI script
exec(open("<%= @wsgi_file %>", "rb").read(), globals())

# Add our Middleware
application = ReverseProxied(application)
